<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Matrix Web Chat Â· HTTP å®¢æˆ·ç«¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      background: radial-gradient(circle at top, #e0f2ff 0, #eef2ff 40%, #f9fafb 100%);
      color: #0f172a;
      overflow: hidden;
    }

    .orb {
      position: fixed;
      border-radius: 999px;
      filter: blur(28px);
      opacity: 0.7;
      pointer-events: none;
      animation: orbFloat 18s ease-in-out infinite alternate;
    }
    .orb.o1 { width: 260px; height: 260px; background: #bfdbfe; top: -50px; left: -60px; }
    .orb.o2 { width: 320px; height: 320px; background: #fecaca; bottom: -80px; right: -40px; animation-duration: 22s; }

    @keyframes orbFloat {
      0%   { transform: translate3d(0,0,0) scale(1); }
      100% { transform: translate3d(30px,-20px,0) scale(1.04); }
    }

    .shell {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 1120px;
      padding: 14px;
    }

    .app {
      display: flex;
      height: calc(100vh - 28px);
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(18px);
      border-radius: 20px;
      box-shadow:
        0 20px 40px rgba(15,23,42,0.18),
        0 0 0 1px rgba(148,163,184,0.25);
      overflow: hidden;
      transform: translateY(10px);
      opacity: 0;
      animation: appIn 0.55s ease-out forwards;
    }

    @keyframes appIn {
      0%   { opacity: 0; transform: translateY(18px) scale(0.98); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* å·¦ä¾§æˆ¿é—´åˆ—è¡¨ */
    .sidebar {
      width: 260px;
      border-right: 1px solid #e5e7eb;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(249,250,251,0.96));
      display: flex;
      flex-direction: column;
      transition: transform 0.25s ease-out;
    }

    .sidebar-header {
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .user-chip {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .avatar {
      width: 30px; height: 30px;
      border-radius: 999px;
      background: conic-gradient(from 180deg, #3b82f6, #a855f7, #3b82f6);
      padding: 2px;
    }
    .avatar-inner {
      width: 100%; height: 100%;
      border-radius: 999px;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: #1f2937;
    }

    .user-meta {
      font-size: 12px;
    }
    .user-meta strong {
      display: block;
      max-width: 130px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .user-meta span {
      color: #6b7280;
      font-size: 11px;
    }

    .sync-indicator {
      font-size: 11px;
      color: #9ca3af;
    }

    .room-search {
      padding: 8px 10px;
    }
    .room-search input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: rgba(249,250,251,0.95);
      font-size: 12px;
      color: #111827;
    }
    .room-search input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.2);
      background: #ffffff;
    }

    .room-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px 6px 8px;
      font-size: 13px;
    }
    .room-item {
      padding: 7px 9px;
      border-radius: 10px;
      margin: 2px 2px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.12s ease, transform 0.08s ease;
    }
    .room-item:hover {
      background: rgba(243,244,246,0.9);
      transform: translateY(-1px);
    }
    .room-item.active {
      background: #e0ecff;
    }
    .room-main {
      min-width: 0;
    }
    .room-name {
      font-weight: 500;
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .room-id {
      font-size: 11px;
      color: #9ca3af;
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .room-preview {
      font-size: 11px;
      color: #9ca3af;
      max-width: 80px;
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .room-empty {
      padding: 10px;
      font-size: 12px;
      color: #9ca3af;
    }

    /* å³ä¾§ä¸»èŠå¤©åŒº */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(248,250,252,0.96);
    }

    .main-header {
      height: 52px;
      border-bottom: 1px solid #e5e7eb;
      padding: 9px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.95);
    }
    .room-info {
      min-width: 0;
    }
    .room-title {
      font-size: 15px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .room-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .icon-btn {
      width: 26px; height: 26px;
      border-radius: 999px;
      border: none;
      background: #eef2ff;
      color: #4b5563;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.12s ease, transform 0.08s ease;
    }
    .icon-btn:hover {
      background: #e0e7ff;
      transform: translateY(-1px);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px 12px 12px;
      background: radial-gradient(circle at top, #fefce8 0, #f9fafb 40%, #f3f4f6 100%);
      font-size: 13px;
    }
    .msg {
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      max-width: 70%;
      animation: msgIn 0.18s ease-out;
    }
    .msg.me {
      margin-left: auto;
      align-items: flex-end;
    }
    .msg-header {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .msg-body {
      padding: 6px 9px;
      border-radius: 10px;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(229,231,235,0.9);
      box-shadow: 0 2px 5px rgba(15,23,42,0.08);
      word-break: break-word;
    }
    .msg.me .msg-body {
      background: #2563eb;
      color: #eff6ff;
      border-color: transparent;
    }

    @keyframes msgIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .empty-state {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      padding: 0 20px;
    }

    .input-area {
      border-top: 1px solid #e5e7eb;
      padding: 8px 10px 9px;
      background: rgba(255,255,255,0.96);
    }
    .input-inner {
      display: flex;
      align-items: flex-end;
      gap: 6px;
    }

    .input-box {
      flex: 1;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 4px 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .input-tools {
      display: flex;
      gap: 4px;
      padding: 0 2px 0 1px;
    }
    .input-tools button {
      border: none;
      background: transparent;
      font-size: 15px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.1s ease, transform 0.08s ease;
    }
    .input-tools button:hover { opacity: 1; transform: translateY(-1px); }

    textarea {
      width: 100%;
      border: none;
      background: transparent;
      resize: none;
      max-height: 90px;
      font-size: 13px;
      color: #111827;
    }
    textarea:focus { outline: none; }

    .send-btn {
      width: 70px;
      padding: 8px 0;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 10px 18px rgba(22,163,74,0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }
    .send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(22,163,74,0.4);
      filter: brightness(1.03);
    }
    .send-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 6px 14px rgba(22,163,74,0.3);
    }

    .footer-status {
      font-size: 11px;
      color: #9ca3af;
      padding: 2px 12px 6px;
    }

    /* é¡¶éƒ¨å°å±èœå•æŒ‰é’® */
    .hamburger {
      display: none;
      width: 26px; height: 26px;
      border-radius: 999px;
      border: none;
      background: #e5e7eb;
      font-size: 15px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      margin-right: 6px;
    }

    @media (max-width: 840px) {
      .app { flex-direction: column; }
      .sidebar {
        position: absolute;
        left: 0; top: 0;
        bottom: 0;
        z-index: 10;
        transform: translateX(-100%);
        box-shadow: 10px 0 24px rgba(15,23,42,0.25);
      }
      .sidebar.open { transform: translateX(0); }
      .hamburger { display: inline-flex; }
    }

    ::-webkit-scrollbar { width: 7px; height: 7px; }
    ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 999px; }
    ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
  </style>
</head>
<body>
  <div class="orb o1"></div>
  <div class="orb o2"></div>

  <div class="shell">
    <div class="app">
      <!-- å·¦ä¾§æˆ¿é—´åˆ—è¡¨ -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="user-chip">
            <div class="avatar"><div class="avatar-inner" id="avatarText">U</div></div>
            <div class="user-meta">
              <strong id="userIdLabel">æœªç™»å½•</strong>
              <span id="homeserverLabel"></span>
            </div>
          </div>
          <div class="sync-indicator" id="syncState">ç­‰å¾…åŒæ­¥â€¦</div>
        </div>
        <div class="room-search">
          <input id="roomSearch" placeholder="æœç´¢æˆ¿é—´â€¦" />
        </div>
        <div class="room-list" id="roomList">
          <div class="room-empty">æ­£åœ¨åŠ è½½åŠ å…¥çš„æˆ¿é—´åˆ—è¡¨â€¦</div>
        </div>
      </aside>

      <!-- å³ä¾§èŠå¤©ä¸»åŒº -->
      <main class="main">
        <div class="main-header">
          <div style="display:flex;align-items:center;gap:6px;min-width:0;">
            <button class="hamburger" id="menuBtn">â˜°</button>
            <div class="room-info">
              <div class="room-title" id="roomTitle">è¯·é€‰æ‹©å·¦ä¾§çš„æˆ¿é—´</div>
              <div class="room-subtitle" id="roomSubtitle">å°šæœªé€‰æ‹©æˆ¿é—´</div>
            </div>
          </div>
          <div class="header-actions">
            <button class="icon-btn" title="ä»… UI è£…é¥°">â‹¯</button>
          </div>
        </div>

        <div class="messages" id="messages">
          <div class="empty-state">ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæˆ¿é—´åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºæœ€è¿‘çš„æ¶ˆæ¯ã€‚</div>
        </div>

        <div class="input-area">
          <div class="input-inner">
            <div class="input-box">
              <div class="input-tools">
                <button title="è¡¨æƒ… (ä»… UI)">ğŸ˜Š</button>
                <button title="é™„ä»¶ (å ä½)">ğŸ“</button>
              </div>
              <textarea id="msgInput" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œå›è½¦å‘é€ï¼ˆShift+å›è½¦æ¢è¡Œï¼‰"></textarea>
            </div>
            <button class="send-btn" id="sendBtn">å‘é€</button>
          </div>
        </div>
        <div class="footer-status" id="footerStatus">å°šæœªå¼€å§‹åŒæ­¥ã€‚</div>
      </main>
    </div>
  </div>

  <script>
    // ====== å‚æ•°ä¸å…¨å±€çŠ¶æ€ ======
    const $ = id => document.getElementById(id);

    const urlParams = new URLSearchParams(location.search);
    let hsUrl = (urlParams.get("hs") || "").replace(/\/+$/, "");
    let accessToken = urlParams.get("access_token") || "";
    let userId = urlParams.get("user_id") || ""; // å¯é€‰

    if (!hsUrl && localStorage.getItem("mx_hs")) {
      hsUrl = localStorage.getItem("mx_hs");
    }
    if (!accessToken && localStorage.getItem("mx_token")) {
      accessToken = localStorage.getItem("mx_token");
    }

    if (!hsUrl || !accessToken) {
      $('footerStatus').textContent = "ç¼ºå°‘ hs / access_tokenï¼Œè¯·å…ˆä»ç™»å½•é¡µè·³è½¬è¿‡æ¥ã€‚";
    }

    localStorage.setItem("mx_hs", hsUrl);
    localStorage.setItem("mx_token", accessToken);

    let syncToken = null;
    let rooms = {};  // roomId -> { name, lastPreview, messages: [] }
    let currentRoomId = null;
    let syncing = false;

    // ====== UI åˆå§‹åŒ– ======
    $('homeserverLabel').textContent = hsUrl || "æ—  homeserver";
    if (userId) {
      $('userIdLabel').textContent = userId;
      $('avatarText').textContent = userId[1] || "U";
    }

    $('menuBtn').onclick = () => {
      $('sidebar').classList.toggle('open');
    };

    $('roomSearch').addEventListener('input', () => {
      const q = $('roomSearch').value.trim().toLowerCase();
      document.querySelectorAll('.room-item').forEach(it => {
        const name = (it.dataset.name || "").toLowerCase();
        const id = (it.dataset.roomId || "").toLowerCase();
        it.style.display = (name.includes(q) || id.includes(q)) ? "flex" : "none";
      });
    });

    $('msgInput').addEventListener('input', (e) => {
      const ta = e.target;
      ta.style.height = "auto";
      ta.style.height = Math.min(ta.scrollHeight, 90) + "px";
    });

    $('msgInput').addEventListener('keydown', (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    $('sendBtn').onclick = sendMessage;

    // ====== æ ¸å¿ƒï¼šHTTP /sync å¾ªç¯ ======
    async function startSyncLoop() {
      if (!hsUrl || !accessToken) return;
      if (syncing) return;
      syncing = true;
      $('syncState').textContent = "åŒæ­¥ä¸­â€¦";

      while (true) {
        try {
          const params = new URLSearchParams();
          if (syncToken) params.set("since", syncToken);
          params.set("timeout", syncToken ? "30000" : "0"); // åˆå§‹åŒæ­¥ä¸é•¿è½®è¯¢ã€‚[web:9][web:112]

          const res = await fetch(
            hsUrl + "/_matrix/client/v3/sync?" + params.toString(),
            {
              method: "GET",
              headers: {
                "Authorization": "Bearer " + accessToken
              }
            }
          ); // æ ‡å‡† /sync æ¥å£ï¼Œä»æœåŠ¡å™¨æ‹‰å–æˆ¿é—´ä¸æ¶ˆæ¯äº‹ä»¶ã€‚[web:6][web:9][web:115]

          if (!res.ok) {
            const text = await res.text();
            $('footerStatus').textContent =
              "åŒæ­¥å¤±è´¥ï¼š" + res.status + " " + res.statusText;
            console.error("sync error", text);
            await new Promise(r => setTimeout(r, 5000));
            continue;
          }

          const data = await res.json();
          syncToken = data.next_batch;
          $('footerStatus').textContent = "åŒæ­¥æˆåŠŸï¼Œnext_batch å·²æ›´æ–°ã€‚";
          handleSyncData(data);
          $('syncState').textContent = "å®æ—¶åŒæ­¥ä¸­";
        } catch (e) {
          console.error("sync loop exception", e);
          $('footerStatus').textContent = "åŒæ­¥å¼‚å¸¸ï¼š" + e.message;
          await new Promise(r => setTimeout(r, 5000));
        }
      }
    }

    function handleSyncData(data) {
      if (!data.rooms || !data.rooms.join) return;
      const join = data.rooms.join;

      Object.keys(join).forEach(roomId => {
        const r = join[roomId];
        if (!rooms[roomId]) {
          rooms[roomId] = {
            name: guessRoomName(roomId, r),
            messages: [],
            lastPreview: ""
          };
        }

        // å¤„ç† timeline é‡Œçš„æ¶ˆæ¯äº‹ä»¶ã€‚[web:112][web:118]
        if (r.timeline && Array.isArray(r.timeline.events)) {
          r.timeline.events.forEach(ev => {
            if (ev.type !== "m.room.message") return;
            if (!ev.content || !ev.content.body) return;

            const msg = {
              id: ev.event_id || (ev.origin_server_ts + "_" + Math.random()),
              sender: ev.sender || "",
              body: ev.content.body,
              ts: ev.origin_server_ts || Date.now()
            };

            const list = rooms[roomId].messages;
            if (!list.find(x => x.id === msg.id)) {
              list.push(msg);
            }
            rooms[roomId].lastPreview = msg.body;
          });
        }
      });

      renderRoomList();

      // å¦‚æœå½“å‰æ²¡é€‰æˆ¿é—´ï¼Œè‡ªåŠ¨é€‰ä¸€ä¸ª
      if (!currentRoomId) {
        const firstId = Object.keys(rooms)[0];
        if (firstId) {
          selectRoom(firstId);
        }
      } else {
        // é€‰ä¸­çš„æˆ¿é—´åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
        renderMessages(currentRoomId);
      }
    }

    function guessRoomName(roomId, roomObj) {
      // ç®€åŒ–ï¼šä¼˜å…ˆ state é‡Œçš„ m.room.nameï¼Œå¦åˆ™ fallback roomIdã€‚[web:112]
      if (roomObj.state && Array.isArray(roomObj.state.events)) {
        for (const ev of roomObj.state.events) {
          if (ev.type === "m.room.name" && ev.content && ev.content.name) {
            return ev.content.name;
          }
        }
      }
      return roomId;
    }

    // ====== æˆ¿é—´ä¸æ¶ˆæ¯æ¸²æŸ“ ======
    function renderRoomList() {
      const container = $('roomList');
      container.innerHTML = "";
      const ids = Object.keys(rooms);
      if (!ids.length) {
        const d = document.createElement("div");
        d.className = "room-empty";
        d.textContent = "å½“å‰è´¦å·æ²¡æœ‰åŠ å…¥ä»»ä½•æˆ¿é—´ã€‚";
        container.appendChild(d);
        return;
      }

      ids.sort((a, b) => {
        const la = rooms[a].messages.at(-1)?.ts || 0;
        const lb = rooms[b].messages.at(-1)?.ts || 0;
        return lb - la;
      });

      ids.forEach(id => {
        const info = rooms[id];
        const div = document.createElement("div");
        div.className = "room-item" + (id === currentRoomId ? " active" : "");
        div.dataset.roomId = id;
        div.dataset.name = info.name;

        const preview = info.lastPreview || "";

        div.innerHTML = `
          <div class="room-main">
            <div class="room-name">${escapeHtml(info.name)}</div>
            <div class="room-id">${escapeHtml(id)}</div>
          </div>
          <div class="room-preview">${escapeHtml(preview)}</div>
        `;

        div.onclick = () => {
          selectRoom(id);
          // å°å±å¹•ç‚¹å®Œæˆ¿é—´æ”¶èµ·ä¾§è¾¹æ 
          if (window.innerWidth <= 840) {
            $('sidebar').classList.remove('open');
          }
        };

        container.appendChild(div);
      });
    }

    function selectRoom(roomId) {
      currentRoomId = roomId;
      const info = rooms[roomId];

      $('roomTitle').textContent = info ? info.name : roomId;
      $('roomSubtitle').textContent = roomId;

      document.querySelectorAll('.room-item').forEach(it => {
        it.classList.toggle('active', it.dataset.roomId === roomId);
      });

      renderMessages(roomId);
    }

    function renderMessages(roomId) {
      const box = $('messages');
      box.innerHTML = "";
      const info = rooms[roomId];
      if (!info || !info.messages.length) {
        const d = document.createElement("div");
        d.className = "empty-state";
        d.textContent = "è¿™ä¸ªæˆ¿é—´ç›®å‰æ²¡æœ‰æ¶ˆæ¯ï¼Œå‘é€ä¸€æ¡è¯•è¯•ã€‚";
        box.appendChild(d);
        return;
      }

      info.messages
        .slice()
        .sort((a, b) => a.ts - b.ts)
        .slice(-80)
        .forEach(msg => {
          const div = document.createElement("div");
          const isMe = userId && msg.sender === userId;

          div.className = "msg" + (isMe ? " me" : "");
          const date = new Date(msg.ts);
          const time = date.toTimeString().slice(0,5);

          div.innerHTML = `
            <div class="msg-header">${escapeHtml(msg.sender || "")} Â· ${time}</div>
            <div class="msg-body">${escapeHtml(msg.body)}</div>
          `;
          box.appendChild(div);
        });

      box.scrollTop = box.scrollHeight;
    }

    // ====== å‘é€æ¶ˆæ¯ï¼šHTTP PUT /rooms/{roomId}/send/m.room.message/{txnId} ======
    async function sendMessage() {
      if (!currentRoomId) {
        $('footerStatus').textContent = "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæˆ¿é—´ã€‚";
        return;
      }
      const text = $('msgInput').value.trim();
      if (!text) return;

      if (!hsUrl || !accessToken) {
        $('footerStatus').textContent = "ç¼ºå°‘ hs / access_tokenï¼Œæ— æ³•å‘é€ã€‚";
        return;
      }

      const content = {
        msgtype: "m.text",
        body: text
      }; // æ ‡å‡† m.room.message æ–‡æœ¬äº‹ä»¶å†…å®¹ã€‚[web:6][web:71]

      const txnId = "web_" + Date.now();

      const url =
        hsUrl +
        "/_matrix/client/v3/rooms/" +
        encodeURIComponent(currentRoomId) +
        "/send/m.room.message/" +
        encodeURIComponent(txnId); // ç¬¦åˆ Matrix Clientâ€‘Server send äº‹ä»¶è§„èŒƒã€‚[web:6][web:9][web:71]

      $('footerStatus').textContent = "å‘é€ä¸­â€¦";

      try {
        const res = await fetch(url, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + accessToken
          },
          body: JSON.stringify(content)
        });
        const data = await res.json();
        if (!res.ok) {
          $('footerStatus').textContent =
            "å‘é€å¤±è´¥ï¼š" + (data.error || (res.status + " " + res.statusText));
          console.error("send error", data);
          return;
        }
        $('footerStatus').textContent = "å‘é€æˆåŠŸã€‚event_id=" + (data.event_id || "");
        $('msgInput').value = "";
        $('msgInput').style.height = "auto";

        // ç«‹å³æœ¬åœ°å›æ˜¾ä¸€æ¡â€œè‡ªå·±å‘çš„æ¶ˆæ¯â€
        const msg = {
          id: data.event_id || ("local_" + Date.now()),
          sender: userId || "",
          body: text,
          ts: Date.now()
        };
        if (!rooms[currentRoomId]) {
          rooms[currentRoomId] = { name: currentRoomId, messages: [], lastPreview: "" };
        }
        rooms[currentRoomId].messages.push(msg);
        rooms[currentRoomId].lastPreview = text;
        renderMessages(currentRoomId);
        renderRoomList();
      } catch (e) {
        console.error(e);
        $('footerStatus').textContent = "å‘é€å¼‚å¸¸ï¼š" + e.message;
      }
    }

    // ====== å·¥å…·å‡½æ•° ======
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    // å¯åŠ¨åŒæ­¥
    startSyncLoop();
  </script>
</body>
</html>
