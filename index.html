<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signal Bot Manager - æ™ºèƒ½æœºå™¨äººç®¡ç†ç³»ç»Ÿ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3797f0;
            --primary-dark: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-main: #fafafa;
            --bg-card: #ffffff;
            --text-primary: #262626;
            --text-secondary: #8e8e8e;
            --border: #dbdbdb;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            color: white;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header p {
            opacity: 0.9;
            font-size: 15px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .card-header h2 {
            font-size: 20px;
            font-weight: 600;
            flex: 1;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--bg-card);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(55, 151, 240, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 14px 18px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--success);
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--danger);
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid var(--primary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-badge.online {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: var(--success);
        }

        .status-dot.offline {
            background: var(--danger);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .rule-item {
            background: var(--bg-main);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .rule-item:hover {
            background: #f0f0f0;
        }

        .rule-content {
            flex: 1;
        }

        .rule-keyword {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .rule-reply {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .message-item {
            background: var(--bg-main);
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid var(--primary);
            animation: slideIn 0.3s ease;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .message-sender {
            font-weight: 600;
            color: var(--primary);
        }

        .message-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .message-text {
            color: var(--text-primary);
            line-height: 1.5;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .messages-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: var(--bg-main);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .tab-container {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .qr-code-container {
            text-align: center;
            padding: 20px;
        }

        .qr-code-container img {
            max-width: 300px;
            border: 2px solid var(--border);
            border-radius: 8px;
            margin: 20px 0;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>
                <span>ğŸ“±</span>
                Signal Bot Manager
            </h1>
            <p>æ™ºèƒ½åŒ–Signalæœºå™¨äººç®¡ç†å¹³å° - å®‰å…¨ã€é«˜æ•ˆã€æ˜“ç”¨</p>
        </div>

        <!-- Stats Dashboard -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="statMessages">0</div>
                <div class="stat-label">å·²æ¥æ”¶æ¶ˆæ¯</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statRules">0</div>
                <div class="stat-label">å›å¤è§„åˆ™</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statReplies">0</div>
                <div class="stat-label">è‡ªåŠ¨å›å¤æ•°</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Setup Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">ğŸš€</div>
                    <h2>åˆ›å»º&é…ç½®æœºå™¨äºº</h2>
                </div>

                <div class="tab-container">
                    <button class="tab active" onclick="switchTab(0)">æ³¨å†Œæ–°å·</button>
                    <button class="tab" onclick="switchTab(1)">é“¾æ¥è®¾å¤‡</button>
                    <button class="tab" onclick="switchTab(2)">APIé…ç½®</button>
                </div>

                <!-- Tab 0: Register -->
                <div class="tab-content active" id="tab0">
                    <div class="form-group">
                        <label>ğŸ“ æ‰‹æœºå·ç  (å›½é™…æ ¼å¼)</label>
                        <input type="text" id="registerPhone" placeholder="+8613800138000">
                    </div>
                    <div class="form-group">
                        <label>ğŸ” éªŒè¯æ–¹å¼</label>
                        <select id="verifyMethod">
                            <option value="sms">çŸ­ä¿¡éªŒè¯</option>
                            <option value="voice">è¯­éŸ³éªŒè¯</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="registerNumber()">
                            <span>å‘é€éªŒè¯ç </span>
                        </button>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label>éªŒè¯ç </label>
                        <input type="text" id="verifyCode" placeholder="è¾“å…¥æ”¶åˆ°çš„6ä½éªŒè¯ç ">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="verifyNumber()">
                            <span>âœ“ éªŒè¯å¹¶æ¿€æ´»</span>
                        </button>
                    </div>
                    <div id="registerAlert" class="alert"></div>
                </div>

                <!-- Tab 1: Link Device -->
                <div class="tab-content" id="tab1">
                    <p style="margin-bottom: 16px; color: var(--text-secondary);">
                        ä½¿ç”¨ç°æœ‰Signalè´¦å·æ‰«æäºŒç»´ç é“¾æ¥è®¾å¤‡
                    </p>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="generateQRCode()">
                            <span>ç”ŸæˆäºŒç»´ç </span>
                        </button>
                    </div>
                    <div id="qrContainer" class="qr-code-container"></div>
                    <div id="linkAlert" class="alert"></div>
                </div>

                <!-- Tab 2: API Config -->
                <div class="tab-content" id="tab2">
                    <div class="form-group">
                        <label>ğŸ”— APIæœåŠ¡åœ°å€</label>
                        <input type="text" id="apiUrl" value="http://localhost:8080">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“± æœºå™¨äººå·ç </label>
                        <input type="text" id="botNumber" value="+8613800138000">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveConfig()">
                            <span>ğŸ’¾ ä¿å­˜é…ç½®</span>
                        </button>
                        <button class="btn btn-secondary" onclick="testConnection()">
                            <span>ğŸ” æµ‹è¯•è¿æ¥</span>
                        </button>
                    </div>
                    <div id="configAlert" class="alert"></div>
                </div>
            </div>

            <!-- Auto Reply Rules -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">ğŸ¤–</div>
                    <h2>è‡ªåŠ¨å›å¤è§„åˆ™</h2>
                </div>

                <div class="form-group">
                    <label>è§¦å‘å…³é”®è¯</label>
                    <input type="text" id="ruleKeyword" placeholder="ä¾‹å¦‚: ä½ å¥½ã€å¸®åŠ©ã€ä»·æ ¼">
                </div>
                <div class="form-group">
                    <label>å›å¤å†…å®¹</label>
                    <textarea id="ruleReply" rows="3" placeholder="ä¾‹å¦‚: æ‚¨å¥½ï¼æˆ‘æ˜¯è‡ªåŠ¨åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="addRule()">
                        <span>â• æ·»åŠ è§„åˆ™</span>
                    </button>
                </div>

                <div id="rulesList" style="margin-top: 24px;"></div>
            </div>

            <!-- Bot Control -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">âš¡</div>
                    <h2>æœºå™¨äººæ§åˆ¶</h2>
                </div>

                <div style="margin-bottom: 20px;">
                    <span class="status-badge" id="botStatusBadge">
                        <span class="status-dot offline"></span>
                        <span>ç¦»çº¿</span>
                    </span>
                </div>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="startBot()">
                        <span>â–¶ å¯åŠ¨æœºå™¨äºº</span>
                    </button>
                    <button class="btn btn-danger" onclick="stopBot()">
                        <span>â¹ åœæ­¢æœºå™¨äºº</span>
                    </button>
                </div>

                <div style="margin-top: 20px;">
                    <div class="form-group">
                        <label>æµ‹è¯•å‘é€æ¶ˆæ¯</label>
                        <input type="text" id="testRecipient" placeholder="æ¥æ”¶è€…å·ç  +8613900139000">
                    </div>
                    <div class="form-group">
                        <textarea id="testMessage" rows="2" placeholder="æµ‹è¯•æ¶ˆæ¯å†…å®¹"></textarea>
                    </div>
                    <button class="btn btn-secondary" onclick="sendTestMessage()">
                        <span>ğŸ“¤ å‘é€æµ‹è¯•</span>
                    </button>
                </div>

                <div id="controlAlert" class="alert"></div>
            </div>

            <!-- Messages Monitor -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-header">
                    <div class="card-icon">ğŸ’¬</div>
                    <h2>æ¶ˆæ¯ç›‘æ§</h2>
                    <button class="btn btn-secondary" onclick="clearMessages()">
                        <span>ğŸ—‘ æ¸…ç©º</span>
                    </button>
                </div>

                <div id="messagesContainer" class="messages-container">
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <p>æš‚æ— æ¶ˆæ¯</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let config = {
            apiUrl: 'http://localhost:8080',
            botNumber: '+8613800138000'
        };
        let rules = [];
        let botRunning = false;
        let pollInterval = null;
        let messages = [];
        let stats = { messages: 0, replies: 0 };

        // Initialize
        window.onload = function() {
            loadConfig();
            loadRules();
            updateStats();
        };

        // Tab Switching
        function switchTab(index) {
            document.querySelectorAll('.tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
        }

        // Config Management
        function saveConfig() {
            config.apiUrl = document.getElementById('apiUrl').value.trim();
            config.botNumber = document.getElementById('botNumber').value.trim();
            localStorage.setItem('signalBotConfig', JSON.stringify(config));
            showAlert('configAlert', 'âœ“ é…ç½®å·²ä¿å­˜', 'success');
        }

        function loadConfig() {
            const saved = localStorage.getItem('signalBotConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('apiUrl').value = config.apiUrl;
                document.getElementById('botNumber').value = config.botNumber;
            }
        }

        async function testConnection() {
            showAlert('configAlert', 'æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
            try {
                const response = await fetch(`${config.apiUrl}/v1/about`);
                if (response.ok) {
                    const data = await response.json();
                    showAlert('configAlert', `âœ“ è¿æ¥æˆåŠŸï¼ç‰ˆæœ¬: ${data.versions?.['signal-cli-rest-api'] || 'unknown'}`, 'success');
                } else {
                    showAlert('configAlert', 'âœ— è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIåœ°å€', 'error');
                }
            } catch (error) {
                showAlert('configAlert', 'âœ— æ— æ³•è¿æ¥åˆ°APIæœåŠ¡: ' + error.message, 'error');
            }
        }

        // Registration
        async function registerNumber() {
            const phone = document.getElementById('registerPhone').value.trim();
            const method = document.getElementById('verifyMethod').value;
            
            if (!phone) {
                showAlert('registerAlert', 'è¯·è¾“å…¥æ‰‹æœºå·ç ', 'error');
                return;
            }

            showAlert('registerAlert', 'æ­£åœ¨å‘é€éªŒè¯ç ...', 'info');
            
            try {
                const body = method === 'voice' ? JSON.stringify({ use_voice: true }) : '';
                const response = await fetch(`${config.apiUrl}/v1/register/${encodeURIComponent(phone)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: body
                });

                if (response.ok) {
                    config.botNumber = phone;
                    document.getElementById('botNumber').value = phone;
                    saveConfig();
                    showAlert('registerAlert', `âœ“ éªŒè¯ç å·²å‘é€åˆ° ${phone}ï¼Œè¯·æŸ¥æ”¶`, 'success');
                } else {
                    const error = await response.text();
                    showAlert('registerAlert', 'âœ— å‘é€å¤±è´¥: ' + error, 'error');
                }
            } catch (error) {
                showAlert('registerAlert', 'âœ— è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function verifyNumber() {
            const phone = document.getElementById('registerPhone').value.trim();
            const code = document.getElementById('verifyCode').value.trim();
            
            if (!code) {
                showAlert('registerAlert', 'è¯·è¾“å…¥éªŒè¯ç ', 'error');
                return;
            }

            showAlert('registerAlert', 'æ­£åœ¨éªŒè¯...', 'info');
            
            try {
                const response = await fetch(`${config.apiUrl}/v1/register/${encodeURIComponent(phone)}/verify/${code}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showAlert('registerAlert', 'âœ“ éªŒè¯æˆåŠŸï¼æœºå™¨äººè´¦å·å·²æ¿€æ´»', 'success');
                    setTimeout(() => switchTab(2), 2000);
                } else {
                    const error = await response.text();
                    showAlert('registerAlert', 'âœ— éªŒè¯å¤±è´¥: ' + error, 'error');
                }
            } catch (error) {
                showAlert('registerAlert', 'âœ— éªŒè¯è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // QR Code Linking
        async function generateQRCode() {
            showAlert('linkAlert', 'æ­£åœ¨ç”ŸæˆäºŒç»´ç ...', 'info');
            try {
                const deviceName = 'SignalBot_' + Date.now();
                const response = await fetch(`${config.apiUrl}/v1/qrcodelink?device_name=${deviceName}`);
                
                if (response.ok) {
                    const data = await response.text();
                    const qrContainer = document.getElementById('qrContainer');
                    
                    // Parse the URL from response
                    const urlMatch = data.match(/tsdevice:\/\?[^\s"]+/);
                    if (urlMatch) {
                        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(urlMatch[0])}`;
                        qrContainer.innerHTML = `
                            <img src="${qrUrl}" alt="QR Code">
                            <p style="color: var(--text-secondary); font-size: 14px;">
                                è¯·ä½¿ç”¨Signalæ‰‹æœºAppæ‰«æäºŒç»´ç <br>
                                è®¾ç½® â†’ å…³è”çš„è®¾å¤‡ â†’ é“¾æ¥æ–°è®¾å¤‡
                            </p>
                        `;
                        showAlert('linkAlert', 'âœ“ äºŒç»´ç å·²ç”Ÿæˆï¼Œè¯·æ‰«æ', 'success');
                    }
                } else {
                    showAlert('linkAlert', 'âœ— ç”Ÿæˆå¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('linkAlert', 'âœ— è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Rules Management
        function addRule() {
            const keyword = document.getElementById('ruleKeyword').value.trim();
            const reply = document.getElementById('ruleReply').value.trim();
            
            if (!keyword || !reply) {
                alert('âš ï¸ è¯·å¡«å†™å…³é”®è¯å’Œå›å¤å†…å®¹');
                return;
            }

            rules.push({ keyword, reply });
            localStorage.setItem('signalBotRules', JSON.stringify(rules));
            
            document.getElementById('ruleKeyword').value = '';
            document.getElementById('ruleReply').value = '';
            
            displayRules();
            updateStats();
        }

        function loadRules() {
            const saved = localStorage.getItem('signalBotRules');
            if (saved) {
                rules = JSON.parse(saved);
                displayRules();
            }
        }

        function displayRules() {
            const container = document.getElementById('rulesList');
            
            if (rules.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>æš‚æ— è§„åˆ™ï¼Œæ·»åŠ ç¬¬ä¸€æ¡è§„åˆ™å¼€å§‹è‡ªåŠ¨å›å¤</p></div>';
                return;
            }

            container.innerHTML = rules.map((rule, index) => `
                <div class="rule-item">
                    <div class="rule-content">
                        <div class="rule-keyword">ğŸ”‘ ${rule.keyword}</div>
                        <div class="rule-reply">ğŸ’¬ ${rule.reply}</div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteRule(${index})" style="padding: 8px 16px;">åˆ é™¤</button>
                </div>
            `).join('');
        }

        function deleteRule(index) {
            rules.splice(index, 1);
            localStorage.setItem('signalBotRules', JSON.stringify(rules));
            displayRules();
            updateStats();
        }

        // Bot Control
        function startBot() {
            if (botRunning) {
                showAlert('controlAlert', 'âš ï¸ æœºå™¨äººå·²åœ¨è¿è¡Œä¸­', 'error');
                return;
            }

            botRunning = true;
            updateBotStatus();
            showAlert('controlAlert', 'âœ“ æœºå™¨äººå·²å¯åŠ¨ï¼Œæ­£åœ¨ç›‘å¬æ¶ˆæ¯...', 'success');
            
            pollInterval = setInterval(receiveMessages, 3000);
        }

        function stopBot() {
            botRunning = false;
            updateBotStatus();
            
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            
            showAlert('controlAlert', 'âœ“ æœºå™¨äººå·²åœæ­¢', 'success');
        }

        function updateBotStatus() {
            const badge = document.getElementById('botStatusBadge');
            
            if (botRunning) {
                badge.innerHTML = '<span class="status-dot online"></span><span>è¿è¡Œä¸­</span>';
                badge.className = 'status-badge online';
            } else {
                badge.innerHTML = '<span class="status-dot offline"></span><span>ç¦»çº¿</span>';
                badge.className = 'status-badge offline';
            }
        }

        // Messages
        async function receiveMessages() {
            try {
                const response = await fetch(`${config.apiUrl}/v1/receive/${encodeURIComponent(config.botNumber)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        data.forEach(msg => {
                            if (msg.envelope && msg.envelope.dataMessage) {
                                const text = msg.envelope.dataMessage.message;
                                const sender = msg.envelope.source || msg.envelope.sourceNumber;
                                
                                displayMessage(sender, text);
                                processAutoReply(sender, text);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('æ¥æ”¶æ¶ˆæ¯é”™è¯¯:', error);
            }
        }

        function processAutoReply(sender, message) {
            const matchedRule = rules.find(rule => message.includes(rule.keyword));
            
            if (matchedRule && botRunning) {
                sendMessage(sender, matchedRule.reply);
                stats.replies++;
                updateStats();
            }
        }

        async function sendMessage(recipient, message) {
            try {
                const response = await fetch(`${config.apiUrl}/v2/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        number: config.botNumber,
                        recipients: [recipient]
                    })
                });

                if (response.ok) {
                    console.log('âœ“ å·²è‡ªåŠ¨å›å¤:', recipient);
                }
            } catch (error) {
                console.error('å‘é€å¤±è´¥:', error);
            }
        }

        async function sendTestMessage() {
            const recipient = document.getElementById('testRecipient').value.trim();
            const message = document.getElementById('testMessage').value.trim();
            
            if (!recipient || !message) {
                showAlert('controlAlert', 'âš ï¸ è¯·å¡«å†™æ¥æ”¶è€…å’Œæ¶ˆæ¯å†…å®¹', 'error');
                return;
            }

            try {
                await sendMessage(recipient, message);
                showAlert('controlAlert', 'âœ“ æµ‹è¯•æ¶ˆæ¯å·²å‘é€', 'success');
                document.getElementById('testMessage').value = '';
            } catch (error) {
                showAlert('controlAlert', 'âœ— å‘é€å¤±è´¥: ' + error.message, 'error');
            }
        }

        function displayMessage(sender, text) {
            stats.messages++;
            updateStats();
            
            messages.unshift({
                sender,
                text,
                time: new Date().toLocaleString('zh-CN')
            });

            const container = document.getElementById('messagesContainer');
            container.innerHTML = messages.map(msg => `
                <div class="message-item">
                    <div class="message-header">
                        <span class="message-sender">${msg.sender}</span>
                        <span class="message-time">${msg.time}</span>
                    </div>
                    <div class="message-text">${msg.text}</div>
                </div>
            `).join('');
        }

        function clearMessages() {
            messages = [];
            const container = document.getElementById('messagesContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <p>æš‚æ— æ¶ˆæ¯</p>
                </div>
            `;
        }

        // Stats
        function updateStats() {
            document.getElementById('statMessages').textContent = stats.messages;
            document.getElementById('statRules').textContent = rules.length;
            document.getElementById('statReplies').textContent = stats.replies;
        }

        // Alert Helper
        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>
