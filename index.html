<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Telegram Bot èŠå¤©ç•Œé¢</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus/dist/index.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: 'Segoe UI', Tahoma, sans-serif; }
    #app { height: 100vh; }
    .chat-container { display: flex; height: 100%; }
    .contacts { width: 280px; border-right: 1px solid #e4e7ed; overflow-y: auto; background: #fafafa; }
    .contact-item { padding: 12px 16px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid #f0f0f0; }
    .contact-item:hover { background: #ecf5ff; }
    .contact-item.active { background: #409eff; color: white; }
    .chat-panel { flex: 1; display: flex; flex-direction: column; }
    .chat-header { padding: 16px; background: #409eff; color: white; display: flex; justify-content: space-between; align-items: center; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #f5f5f5; }
    .msg-item { margin-bottom: 16px; display: flex; }
    .msg-item.self { justify-content: flex-end; }
    .msg-bubble { max-width: 60%; padding: 10px 14px; border-radius: 8px; word-wrap: break-word; }
    .msg-item.self .msg-bubble { background: #409eff; color: white; }
    .msg-item.other .msg-bubble { background: white; }
    .msg-bubble img, .msg-bubble video { max-width: 100%; border-radius: 4px; }
    .chat-input-area { display: flex; padding: 16px; border-top: 1px solid #e4e7ed; background: white; gap: 8px; }
    .chat-input-area input { flex: 1; }
    @media (max-width: 768px) {
      .contacts { width: 120px; }
      .msg-bubble { max-width: 80%; font-size: 14px; }
    }
  </style>
</head>
<body>
<div id="app">
  <el-container class="chat-container">
    <div class="contacts">
      <el-button type="primary" @click="refreshContacts" style="width:100%; margin-bottom:10px;">åˆ·æ–°è”ç³»äºº</el-button>
      <div v-for="c in contacts" :key="c.id" class="contact-item" :class="{active: c.id===currentContact.id}" @click="selectContact(c)">
        <div style="font-weight:bold;">{{ c.name }}</div>
        <div style="font-size:12px; color:#999;">{{ c.username }}</div>
      </div>
    </div>
    <el-container class="chat-panel">
      <div class="chat-header">
        <div>
          <span style="font-size:18px; font-weight:bold;">{{ currentContact.name || 'è¯·é€‰æ‹©è”ç³»äºº' }}</span>
        </div>
        <div>
          <el-tag :type="botStatus==='è¿è¡Œä¸­'?'success':'info'" size="small">{{ botStatus }}</el-tag>
          <el-button size="small" @click="refreshBotStatus" style="margin-left:8px;">åˆ·æ–°çŠ¶æ€</el-button>
        </div>
      </div>
      <div class="chat-messages" ref="msgPanel">
        <div v-for="msg in messages" :key="msg.id" class="msg-item" :class="msg.isSelf?'self':'other'">
          <div class="msg-bubble">
            <div v-if="msg.type==='text'">{{ msg.text }}</div>
            <img v-else-if="msg.type==='photo'" :src="msg.url" @click="previewImage(msg.url)">
            <video v-else-if="msg.type==='video'" :src="msg.url" controls></video>
            <audio v-else-if="msg.type==='audio'" :src="msg.url" controls></audio>
            <a v-else-if="msg.type==='file'" :href="msg.url" download style="color:#409eff;">ğŸ“ {{ msg.fileName }}</a>
          </div>
        </div>
      </div>
      <div class="chat-input-area">
        <el-input v-model="inputMsg" @keyup.enter="sendMessage" placeholder="è¾“å…¥æ¶ˆæ¯æŒ‰Enterå‘é€"></el-input>
        <el-upload :action="uploadUrl" :before-upload="beforeUpload" :on-success="uploadSuccess" :show-file-list="false" multiple>
          <el-button icon="Upload">ä¸Šä¼ </el-button>
        </el-upload>
        <el-button type="primary" @click="sendMessage">å‘é€</el-button>
      </div>
    </el-container>
  </el-container>
</div>

<script src="https://unpkg.com/vue@3"></script>
<script src="https://cdn.jsdelivr.net/npm/element-plus"></script>
<script src="https://unpkg.com/element-plus/dist/locale/zh-cn.js"></script>
<script>
// Tokenåˆ†æ®µæ··æ·†å­˜å‚¨ï¼ˆBase64ç¼–ç ï¼‰
const _0x4a2b=['ODI1OTc1MjMyMzpBQUVwYVgt','QTNDaTJuaUc0RFVkdFpqdWJ4','TDdCbWtiYTREYw=='];
const _tk = () => atob(_0x4a2b[0] + _0x4a2b[1] + _0x4a2b[2]);

const { createApp } = Vue;
const app = createApp({
  data() {
    return {
      token: '',
      contacts: [],
      currentContact: {},
      messages: [],
      inputMsg: '',
      botStatus: 'æ£€æµ‹ä¸­...',
      uploadUrl: ''
    };
  },
  mounted() {
    this.token = _tk(); // è§£ç ä»¤ç‰Œ
    this.apiBase = `https://api.telegram.org/bot${this.token}`;
    this.refreshBotStatus();
    this.refreshContacts();
  },
  methods: {
    async refreshBotStatus() {
      try {
        const res = await fetch(`${this.apiBase}/getMe`);
        const data = await res.json();
        this.botStatus = data.ok ? 'è¿è¡Œä¸­' : 'ç¦»çº¿';
      } catch(e) {
        this.botStatus = 'è¿æ¥å¤±è´¥';
      }
    },
    async refreshContacts() {
      try {
        const res = await fetch(`${this.apiBase}/getUpdates`);
        const data = await res.json();
        if(data.ok) {
          const uniqueChats = new Map();
          data.result.forEach(u => {
            if(u.message?.chat) {
              const c = u.message.chat;
              uniqueChats.set(c.id, {
                id: c.id,
                name: c.first_name || c.title || 'Unknown',
                username: c.username || ''
              });
            }
          });
          this.contacts = Array.from(uniqueChats.values());
        }
      } catch(e) {
        console.error('è·å–è”ç³»äººå¤±è´¥', e);
      }
    },
    selectContact(c) {
      this.currentContact = c;
      this.loadMessages(c.id);
    },
    async loadMessages(chatId) {
      this.messages = [];
      try {
        const res = await fetch(`${this.apiBase}/getUpdates`);
        const data = await res.json();
        if(data.ok) {
          data.result.forEach(u => {
            const msg = u.message;
            if(msg?.chat?.id === chatId) {
              let msgObj = {
                id: msg.message_id,
                isSelf: false,
                type: 'text',
                text: msg.text || ''
              };
              if(msg.photo) {
                msgObj.type = 'photo';
                msgObj.url = `https://api.telegram.org/file/bot${this.token}/${msg.photo[msg.photo.length-1].file_path}`;
              } else if(msg.video) {
                msgObj.type = 'video';
                msgObj.url = `https://api.telegram.org/file/bot${this.token}/${msg.video.file_path}`;
              } else if(msg.audio) {
                msgObj.type = 'audio';
                msgObj.url = `https://api.telegram.org/file/bot${this.token}/${msg.audio.file_path}`;
              } else if(msg.document) {
                msgObj.type = 'file';
                msgObj.fileName = msg.document.file_name;
                msgObj.url = `https://api.telegram.org/file/bot${this.token}/${msg.document.file_path}`;
              }
              this.messages.push(msgObj);
            }
          });
        }
      } catch(e) {
        console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥', e);
      }
      this.$nextTick(() => this.scrollBottom());
    },
    async sendMessage() {
      if(!this.inputMsg.trim() || !this.currentContact.id) return;
      try {
        await fetch(`${this.apiBase}/sendMessage`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            chat_id: this.currentContact.id,
            text: this.inputMsg
          })
        });
        this.messages.push({
          id: Date.now(),
          isSelf: true,
          type: 'text',
          text: this.inputMsg
        });
        this.inputMsg = '';
        this.$nextTick(() => this.scrollBottom());
      } catch(e) {
        console.error('å‘é€å¤±è´¥', e);
      }
    },
    beforeUpload(file) {
      return true;
    },
    async uploadSuccess(response, file) {
      // æ–‡ä»¶ä¸Šä¼ åçš„å¤„ç†
      this.messages.push({
        id: Date.now(),
        isSelf: true,
        type: file.raw.type.startsWith('image/') ? 'photo' : 
              file.raw.type.startsWith('video/') ? 'video' : 
              file.raw.type.startsWith('audio/') ? 'audio' : 'file',
        url: URL.createObjectURL(file.raw),
        fileName: file.name
      });
      this.$nextTick(() => this.scrollBottom());
    },
    previewImage(url) {
      window.open(url, '_blank');
    },
    scrollBottom() {
      const panel = this.$refs.msgPanel;
      if(panel) panel.scrollTop = panel.scrollHeight;
    }
  }
});
app.use(ElementPlus, { locale: ElementPlusLocaleZhCn });
app.mount('#app');
</script>
</body>
</html>
