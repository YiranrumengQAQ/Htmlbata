<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signalæœºå™¨äººç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2e86de; margin-bottom: 30px; }
        .section { margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 5px; }
        .section h2 { font-size: 18px; margin-bottom: 15px; color: #333; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #2e86de; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        button:hover { background: #1e6bb8; }
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        .status { padding: 10px; margin-top: 10px; border-radius: 4px; display: none; }
        .status.success { background: #d4edda; color: #155724; display: block; }
        .status.error { background: #f8d7da; color: #721c24; display: block; }
        .messages { max-height: 300px; overflow-y: auto; background: white; padding: 10px; border: 1px solid #ddd; }
        .message-item { padding: 8px; margin-bottom: 8px; background: #e3f2fd; border-radius: 4px; }
        .bot-status { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .bot-status.running { background: #27ae60; }
        .bot-status.stopped { background: #e74c3c; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± Signalæœºå™¨äººç®¡ç†ç³»ç»Ÿ</h1>
        
        <!-- APIé…ç½® -->
        <div class="section">
            <h2>âš™ï¸ APIæœåŠ¡é…ç½®</h2>
            <label>Signal CLI REST APIåœ°å€:</label>
            <input type="text" id="apiUrl" value="http://localhost:8080" placeholder="http://localhost:8080">
            <label>æœºå™¨äººå·ç  (å›½é™…æ ¼å¼):</label>
            <input type="text" id="botNumber" value="+8613800138000" placeholder="+8613800138000">
            <button onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            <div id="configStatus" class="status"></div>
        </div>

        <!-- è‡ªåŠ¨å›å¤è§„åˆ™ -->
        <div class="section">
            <h2>ğŸ¤– è‡ªåŠ¨å›å¤è§„åˆ™</h2>
            <label>å…³é”®è¯:</label>
            <input type="text" id="keyword" placeholder="ä¾‹å¦‚: ä½ å¥½">
            <label>å›å¤å†…å®¹:</label>
            <textarea id="replyText" rows="3" placeholder="ä¾‹å¦‚: æ‚¨å¥½ï¼æˆ‘æ˜¯è‡ªåŠ¨æœºå™¨äºº"></textarea>
            <button onclick="addRule()">æ·»åŠ è§„åˆ™</button>
            <div id="rulesList" style="margin-top: 15px;"></div>
        </div>

        <!-- æœºå™¨äººæ§åˆ¶ -->
        <div class="section">
            <h2>ğŸ® æœºå™¨äººæ§åˆ¶</h2>
            <p>çŠ¶æ€: <span class="bot-status stopped" id="botStatusIndicator"></span><span id="botStatusText">æœªè¿è¡Œ</span></p>
            <button onclick="startBot()">å¯åŠ¨æœºå™¨äºº</button>
            <button onclick="stopBot()" class="danger">åœæ­¢æœºå™¨äºº</button>
            <button onclick="sendTestMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            <div id="controlStatus" class="status"></div>
        </div>

        <!-- æ¶ˆæ¯ç›‘æ§ -->
        <div class="section">
            <h2>ğŸ’¬ æ¥æ”¶çš„æ¶ˆæ¯</h2>
            <div id="messagesContainer" class="messages">
                <p style="color: #999;">æš‚æ— æ¶ˆæ¯</p>
            </div>
            <button onclick="clearMessages()">æ¸…ç©ºæ¶ˆæ¯</button>
        </div>
    </div>

    <script>
        // å…¨å±€é…ç½®
        let config = {
            apiUrl: 'http://localhost:8080',
            botNumber: '+8613800138000'
        };
        let rules = [];
        let botRunning = false;
        let pollInterval = null;
        let receivedMessages = [];

        // åˆå§‹åŒ–
        window.onload = function() {
            loadConfig();
            loadRules();
        };

        // ä¿å­˜é…ç½®
        function saveConfig() {
            config.apiUrl = document.getElementById('apiUrl').value;
            config.botNumber = document.getElementById('botNumber').value;
            localStorage.setItem('signalBotConfig', JSON.stringify(config));
            showStatus('configStatus', 'é…ç½®å·²ä¿å­˜', 'success');
        }

        function loadConfig() {
            const saved = localStorage.getItem('signalBotConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('apiUrl').value = config.apiUrl;
                document.getElementById('botNumber').value = config.botNumber;
            }
        }

        // æ·»åŠ å›å¤è§„åˆ™
        function addRule() {
            const keyword = document.getElementById('keyword').value;
            const reply = document.getElementById('replyText').value;
            if (!keyword || !reply) {
                alert('è¯·å¡«å†™å…³é”®è¯å’Œå›å¤å†…å®¹');
                return;
            }
            rules.push({ keyword, reply });
            localStorage.setItem('signalBotRules', JSON.stringify(rules));
            document.getElementById('keyword').value = '';
            document.getElementById('replyText').value = '';
            displayRules();
        }

        function loadRules() {
            const saved = localStorage.getItem('signalBotRules');
            if (saved) {
                rules = JSON.parse(saved);
                displayRules();
            }
        }

        function displayRules() {
            const container = document.getElementById('rulesList');
            if (rules.length === 0) {
                container.innerHTML = '<p style="color: #999;">æš‚æ— è§„åˆ™</p>';
                return;
            }
            container.innerHTML = rules.map((rule, index) => 
                `<div style="background: white; padding: 10px; margin-bottom: 8px; border-radius: 4px;">
                    <strong>å…³é”®è¯:</strong> ${rule.keyword} â†’ <strong>å›å¤:</strong> ${rule.reply}
                    <button onclick="deleteRule(${index})" style="float: right; padding: 5px 10px; font-size: 12px;" class="danger">åˆ é™¤</button>
                </div>`
            ).join('');
        }

        function deleteRule(index) {
            rules.splice(index, 1);
            localStorage.setItem('signalBotRules', JSON.stringify(rules));
            displayRules();
        }

        // å¯åŠ¨æœºå™¨äºº
        function startBot() {
            if (botRunning) {
                showStatus('controlStatus', 'æœºå™¨äººå·²åœ¨è¿è¡Œä¸­', 'error');
                return;
            }
            botRunning = true;
            updateBotStatus();
            showStatus('controlStatus', 'æœºå™¨äººå·²å¯åŠ¨ï¼Œæ­£åœ¨ç›‘å¬æ¶ˆæ¯...', 'success');
            
            // å¼€å§‹è½®è¯¢æ¥æ”¶æ¶ˆæ¯
            pollInterval = setInterval(receiveMessages, 3000);
        }

        // åœæ­¢æœºå™¨äºº
        function stopBot() {
            botRunning = false;
            updateBotStatus();
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            showStatus('controlStatus', 'æœºå™¨äººå·²åœæ­¢', 'success');
        }

        function updateBotStatus() {
            const indicator = document.getElementById('botStatusIndicator');
            const text = document.getElementById('botStatusText');
            if (botRunning) {
                indicator.className = 'bot-status running';
                text.textContent = 'è¿è¡Œä¸­';
            } else {
                indicator.className = 'bot-status stopped';
                text.textContent = 'æœªè¿è¡Œ';
            }
        }

        // æ¥æ”¶æ¶ˆæ¯
        async function receiveMessages() {
            try {
                const response = await fetch(`${config.apiUrl}/v1/receive/${encodeURIComponent(config.botNumber)}`);
                if (!response.ok) throw new Error('æ¥æ”¶æ¶ˆæ¯å¤±è´¥');
                
                const messages = await response.json();
                if (messages && messages.length > 0) {
                    messages.forEach(msg => {
                        if (msg.envelope && msg.envelope.dataMessage) {
                            const text = msg.envelope.dataMessage.message;
                            const sender = msg.envelope.source || msg.envelope.sourceNumber;
                            displayMessage(sender, text);
                            
                            // è‡ªåŠ¨å›å¤å¤„ç†
                            processAutoReply(sender, text);
                        }
                    });
                }
            } catch (error) {
                console.error('æ¥æ”¶æ¶ˆæ¯é”™è¯¯:', error);
            }
        }

        // å¤„ç†è‡ªåŠ¨å›å¤
        function processAutoReply(sender, message) {
            const matchedRule = rules.find(rule => message.includes(rule.keyword));
            if (matchedRule && botRunning) {
                sendMessage(sender, matchedRule.reply);
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage(recipient, message) {
            try {
                const response = await fetch(`${config.apiUrl}/v2/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        number: config.botNumber,
                        recipients: [recipient]
                    })
                });
                if (!response.ok) throw new Error('å‘é€å¤±è´¥');
                console.log('å·²è‡ªåŠ¨å›å¤:', recipient);
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯é”™è¯¯:', error);
            }
        }

        // å‘é€æµ‹è¯•æ¶ˆæ¯
        async function sendTestMessage() {
            const recipient = prompt('è¯·è¾“å…¥æ¥æ”¶è€…å·ç  (å›½é™…æ ¼å¼, å¦‚ +8613800138000):');
            if (!recipient) return;
            
            try {
                await sendMessage(recipient, 'è¿™æ˜¯æ¥è‡ªSignalæœºå™¨äººçš„æµ‹è¯•æ¶ˆæ¯ï¼');
                showStatus('controlStatus', 'æµ‹è¯•æ¶ˆæ¯å·²å‘é€', 'success');
            } catch (error) {
                showStatus('controlStatus', 'å‘é€å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function displayMessage(sender, text) {
            receivedMessages.unshift({ sender, text, time: new Date().toLocaleString() });
            const container = document.getElementById('messagesContainer');
            container.innerHTML = receivedMessages.map(msg => 
                `<div class="message-item">
                    <strong>${msg.sender}</strong> <small style="color: #999;">${msg.time}</small><br>
                    ${msg.text}
                </div>`
            ).join('');
        }

        function clearMessages() {
            receivedMessages = [];
            document.getElementById('messagesContainer').innerHTML = '<p style="color: #999;">æš‚æ— æ¶ˆæ¯</p>';
        }

        // æ˜¾ç¤ºçŠ¶æ€æç¤º
        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `status ${type}`;
            setTimeout(() => el.className = 'status', 3000);
        }
    </script>
</body>
</html>
