<!-- 1. Telegramé£æ ¼åŸºç¡€UIå’Œæˆ¿é—´åˆ›å»º/åŠ å…¥ç•Œé¢ -->
<!-- 2. ç®€åŒ–peerè¿æ¥å’Œå®‰å…¨åŠ å¯†ï¼Œæ¶ˆæ¯å…¨åŠ å¯† -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>å±€åŸŸç½‘åŠ å¯†èŠå¤©</title>
<style>
body {background:#17212b;color:#fff;font-family:'Segoe UI',Roboto,Arial,sans-serif;margin:0;}
.main {max-width:450px; margin:36px auto;}
.header { background:#1c92d2;padding:12px;border-radius:18px 18px 0 0;text-align:center;}
.header span {font-size:28px;}
.room-set,.input-set { padding:20px;background:#25364a; border-radius:0 0 14px 14px;}
input,textarea {padding:8px;font-size:16px;width:100%;border:none;background:#1e2a39;color:#fff;margin:8px 0;border-radius:8px;}
input:disabled,textarea:disabled {background:#474c52;}
.btn {background:#0088cc;color:#fff;padding:8px 22px;border-radius:18px;font-size:15px;float:right;margin-left:12px;cursor:pointer;border:none;}
.status {margin:8px 0;color:#abdfff;}
.msgbox {background:#101825;min-height:150px;padding:14px;border-radius:10px;overflow-y:auto;max-height:320px;}
.msg {max-width:74%;margin:10px 0;padding:10px 16px;border-radius:14px 14px 2px 14px;background:#2b5278;}
.msg.in {border-radius:14px 14px 14px 2px;background:#182533;align-self:flex-start;}
.msg.out {align-self:flex-end;}
.flex {display:flex; flex-direction:column;gap:4px;}
.time {font-size:10px;color:#8b98a5;text-align:right;}
</style>
</head>
<body>
<div class="main">
<div class="header"><span>ğŸ”’ å±€åŸŸç½‘åŠ å¯†èŠå¤©</span></div>
<div class="room-set" id="roomBox">
  <div><b>åˆ›å»º/åŠ å…¥æˆ¿é—´</b></div>
  <button class="btn" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
  <div>æˆ–</div>
  <textarea id="remoteSDP" rows="3" placeholder="è¾“å…¥å¯¹æ–¹åˆ†äº«çš„æˆ¿é—´ä¿¡æ¯..."></textarea>
  <button class="btn" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
  <div class="status" id="roomStatus"></div>
  <textarea id="mySDP" rows="3" readonly style="margin-top:9px;display:none"></textarea>
</div>
<div class="input-set" style="display:none" id="chatUI">
  <div class="msgbox flex" id="msgList"></div>
  <input type="text" id="msgIn" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled>
  <button class="btn" id="sendBtn" disabled>å‘é€</button>
</div>
</div>
<script>
// ç®€å•å¯¹ç§°å¯†é’¥åŠ å¯†
let secretKey,ckey,iv;
async function genKey(){ ckey = await window.crypto.subtle.generateKey({name:'AES-GCM',length:256},!0,['encrypt','decrypt']); }
async function exportKey(){ return btoa(String.fromCharCode(...new Uint8Array(await crypto.subtle.exportKey('raw',ckey)))); }
async function importKey(base64){ let raw = Uint8Array.from(atob(base64),c=>c.charCodeAt(0)); ckey = await crypto.subtle.importKey('raw',raw,'AES-GCM',!0,['encrypt','decrypt']); }

// WebRTCä¿¡ä»¤ä¸P2Pæ•°æ®é€šé“
let pc, dc, role;
function createRoom() {
  role="host";
  document.getElementById('roomStatus').textContent="æ­£åœ¨åˆ›å»ºæˆ¿é—´...";
  genKey().then(async ()=>{
    iv = crypto.getRandomValues(new Uint8Array(12));
    pc = new RTCPeerConnection();
    dc = pc.createDataChannel('msg');
    setChat();
    let offer = await pc.createOffer(); await pc.setLocalDescription(offer);
    showSDP(await exportKey(), iv, offer.sdp);
    pc.onicecandidate=e=>{
      if(e.candidate) return;
      showSDP(await exportKey(), iv, offer.sdp);
    };
    pc.ondatachannel = e => bindDC(e.channel);
  });
}
function showSDP(key, iv, sdp){
  document.getElementById('mySDP').style.display='block';
  document.getElementById('mySDP').value = JSON.stringify({k:key,v:Array.from(iv),s:sdp});
  document.getElementById('roomStatus').textContent="å¤åˆ¶ä»¥ä¸‹ä¿¡æ¯è®©å¯¹æ–¹åŠ å…¥";
}
function joinRoom() {
  role="join";
  let obj;
  try { obj = JSON.parse(document.getElementById('remoteSDP').value); } catch{alert('æ— æ•ˆæˆ–æœªè¾“å…¥æˆ¿é—´ä¿¡æ¯');return;}
  iv = new Uint8Array(obj.v);
  importKey(obj.k).then(()=>{
    pc = new RTCPeerConnection();
    pc.ondatachannel=e=>{dc=e.channel;bindDC(dc);}
    pc.setRemoteDescription({type:'offer',sdp:obj.s});
    pc.createAnswer().then(ans=>{
      pc.setLocalDescription(ans);
      pc.onicecandidate = e=>{
        if(!e.candidate){
          document.getElementById('mySDP').style.display='block';
          document.getElementById('mySDP').value=JSON.stringify({s:ans.sdp});
          document.getElementById('roomStatus').textContent="å¤åˆ¶ä¸‹æ–¹ä¿¡æ¯å›å¤ç»™å¯¹æ–¹";
        }
      };
    });
  });
}
function bindDC(channel){
  dc = channel;
  dc.onopen = ()=>{ document.getElementById('msgIn').disabled=0; document.getElementById('sendBtn').disabled=0; setChat(); msgAdd('è¿æ¥å·²å»ºç«‹ï¼Œç°åœ¨å¯ä»¥èŠå¤©','in'); };
  dc.onmessage=async e=>{
    let {m,t} = JSON.parse(e.data);
    let d = await crypto.subtle.decrypt({name:'AES-GCM',iv}, ckey,new Uint8Array(m));
    msgAdd(new TextDecoder().decode(d),'in',t);
  };
}
function setChat(){ document.getElementById('chatUI').style.display="block"; }
function msgAdd(text, type, t){ let e=document.createElement('div');e.className='msg '+type;
  e.innerHTML=`<div>${text.replace(/</g,'&lt;')}</div><div class="time">${t||new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})}</div>`;
  document.getElementById('msgList').appendChild(e); document.getElementById('msgList').scrollTop=1e9;
}
document.getElementById('sendBtn').onclick=async ()=>{
  let text=document.getElementById('msgIn').value.trim();
  if(!text) return;
  let e=await crypto.subtle.encrypt({name:'AES-GCM',iv},ckey,new TextEncoder().encode(text));
  dc.send( JSON.stringify({m:Array.from(new Uint8Array(e)), t:new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})}) );
  msgAdd(text, 'out');
  document.getElementById('msgIn').value='';
};
</script>
</body>
</html>
